# SPDX-FileCopyrightText: 2025 INDUSTRIA DE DISEÃ‘O TEXTIL S.A. (INDITEX S.A.)
# SPDX-License-Identifier: Apache-2.0
name: ğŸš€ Release
permissions: read-all

on:
  release:
    types:
      - created

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: inditextech/redkey-operator

jobs:
  release:
    name: ğŸ·ï¸ Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      user_agent_version: ${{ steps.version.outputs.user_agent_version }}
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0
      - name: ğŸ§ª Check bundle generation
        run: |
            make bundle IMAGE_TAG_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: ğŸ“ Load Operator version
        id: version
        run: |
          echo "version=$(make version)" >> $GITHUB_OUTPUT
          echo "user_agent_version=$(cat cmd/main.go | grep 'USER_AGENT_VERSION =' | cut -d'=' -f2 | cut -d'"' -f2)" >> $GITHUB_OUTPUT
          echo $GITHUB_OUTPUT

  check:
    name: ğŸ” Check versions
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Check versions
        run: |
          echo "version: ${{ needs.release.outputs.version }}"
          echo "user_agent_version: ${{ needs.release.outputs.user_agent_version }}"
          echo "tag_name: ${{ github.event.release.tag_name }}"

          if [ "${{ github.event.release.tag_name }}" != "${{ needs.release.outputs.version }}" ]; then
            echo "Version in Makefile does not match release tag"
            exit 1
          fi

          if [ "${{ github.event.release.tag_name }}" != "${{ needs.release.outputs.user_agent_version }}" ]; then
            echo "Version in main.go/USER_AGENT_VERSION does not match release tag"
            exit 1
          fi

  build:
    name: ğŸ› ï¸ Build Operator images
    needs: check
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: ğŸ›ï¸ Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0

      - name: ğŸ” Login into ${{ env.REGISTRY }}
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ—ï¸ Build and push Operator image
        run: |
          make docker-build IMAGE_TAG_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          make docker-push IMAGE_TAG_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
      - name: ğŸ—ï¸ Build and push Operator bundle
        run: |
          make bundle IMAGE_TAG_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          make bundle-build IMAGE_TAG_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          make bundle-push IMAGE_TAG_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
      - name: ğŸ—ï¸ Build and push Operator catalog
        run: |
          make catalog-build IMAGE_TAG_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          make catalog-push IMAGE_TAG_BASE=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
