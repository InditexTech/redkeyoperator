# SPDX-FileCopyrightText: 2025 INDUSTRIA DE DISEÃ‘O TEXTIL S.A. (INDITEX S.A.)
# SPDX-License-Identifier: Apache-2.0

name: E2E tests

on:
  pull_request:
    branches: [main]
    paths-ignore: ['docs/**']

  workflow_dispatch:
    inputs:
      test_parallel_process:
        description: Number of parallel processes for the E2E test suite
        default: '4'
        required: false

concurrency:
  group: e2e-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  OPERATOR_NAME: redkey-operator
  OPERATOR_VERSION: test-e2e
  KUBECONFIG: ${{ github.workspace }}/.kube/config
  LOCAL_CLUSTER_NAME: test-e2e-cluster
  LOCAL_REGISTRY: test-e2e-registry
  LOCAL_REGISTRY_PORT: 5001

jobs:
  e2e:
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    defaults:
      run:
        shell: bash -eu -o pipefail {0}

    steps:
    - name: ğŸ“¥  Checkout code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸  Set up Go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache: true

    - name: ğŸ”§  Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: v1.30.0

    - name: ğŸŒ± Kubernetes KinD Cluster
      id: kind
      uses: helm/kind-action@v1
      with:
        cluster_name: ${{ env.LOCAL_CLUSTER_NAME }}
        registry: true
        registry_name: ${{ env.LOCAL_REGISTRY }}
        registry_port: ${{ env.LOCAL_REGISTRY_PORT }}

    - name: ğŸ—ï¸  Build operator image
      run: make docker-build IMG=${{ steps.kind.outputs.LOCAL_REGISTRY }}/redkey-operator:${{ env.OPERATOR_VERSION }}
        
    - name: ğŸ“¥ Push operator image
      run: make docker-push IMG=${{ steps.kind.outputs.LOCAL_REGISTRY }}/redkey-operator:${{ env.OPERATOR_VERSION }}

    - name: ğŸ“š  Install Ginkgo CLI
      run: go install github.com/onsi/ginkgo/v2/ginkgo@latest
    
    - name: ğŸ“š Install CRD
      run: make install

    - name: âœ…  Run E2E test suite
      run: |
        make test-e2e \
          IMG=${{ steps.kind.outputs.LOCAL_REGISTRY }}/redkey-operator:${{ env.OPERATOR_VERSION }}

    - name: ğŸ§¹  Delete KinD cluster (always)
      if: always()
      run: kind delete cluster --name ${{ env.LOCAL_CLUSTER_NAME }}
