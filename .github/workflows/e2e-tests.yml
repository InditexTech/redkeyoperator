name: E2E tests

on:
  # Run on every PR that touches anything except docs/*
  pull_request:
    branches: [main]
    paths-ignore: ['docs/**']

  # Keep the main branch green every night (02:00 UTC)
  schedule:
    - cron: '0 2 * * *'

  # Manual trigger with an optional override for test parallelism
  workflow_dispatch:
    inputs:
      test_parallel_process:
        description: Number of parallel processes for the E2E test suite
        default: '4'
        required: false

# Cancel stale runs on the same head commit / PR
concurrency:
  group: e2e-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  OPERATOR_NAME: redis-operator
  OPERATOR_VERSION: 0.1.0
  KUBECONFIG: ${{ github.workspace }}/.kube/config
  LOCAL_CLUSTER_NAME: local-cluster-test
  LOCAL_REGISTRY: local-registry-hosting
  LOCAL_REGISTRY_PORT: 5001

jobs:
  e2e:
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    defaults:
      run:
        shell: bash -eu -o pipefail {0}   # strict mode for every Bash step

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ git / go / caching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¥  Checkout code
      uses: actions/checkout@v4

    - name: ğŸ—ï¸  Set up Go (module cache enabled)
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache: true                 # built-in cache for $GOMODCACHE

    # Cache Docker layers to avoid rebuilding unchanged layers on each run
    - name: â™»ï¸  Restore BuildKit layer cache
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: ğŸ³  Prepare Buildx builder
      uses: docker/setup-buildx-action@v3
      with:
        install: true
        driver-opts: |
          image=moby/buildkit:v0.21.0
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to:   type=local,dest=/tmp/.buildx-cache,mode=max

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ kubernetes / kind â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ”§  Install kubectl (CLI version aligned with cluster)
      uses: azure/setup-kubectl@v3
      with:
        version: v1.30.0

    - name: ğŸŒ± Kubernetes KinD Cluster
      id: kind
      uses: helm/kind-action@v1
      with:
        cluster_name: ${{ env.LOCAL_CLUSTER_NAME }}
        registry: true
        registry_name: ${{ env.LOCAL_REGISTRY }}
        registry_port: ${{ env.LOCAL_REGISTRY_PORT }}
        registry_enable_delete: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ build & load images â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ—ï¸  Build operator image and load into KinD
      uses: docker/build-push-action@v5
      with:
        context: .
        tags: ${{ env.OPERATOR_NAME }}:${{ env.OPERATOR_VERSION }}
        load: true                 # makes the image directly visible to docker-d
        push: false
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to:   type=local,dest=/tmp/.buildx-cache,mode=max

    - name: ğŸ“¥ Load operator image into KinD
      run: kind load docker-image --name ${{ env.LOCAL_CLUSTER_NAME }} ${{ env.OPERATOR_NAME }}:${{ env.OPERATOR_VERSION }}

    - name: ğŸ“¦  Pull dependency images & load into KinD
      run: |
        for img in \
          redis/redis-stack-server:7.2.0-v10 \
          redis/redis-stack-server:7.4.0-v3 \
          alpine:3.21.3
        do
          docker pull "$img"
          kind load docker-image --name ${{ env.LOCAL_CLUSTER_NAME }} "$img"
        done

    - name: ğŸ›‚  Validate images are present & runnable inside KinD
      env:
        CLUSTER: ${{ env.LOCAL_CLUSTER_NAME || 'local-cluster-test' }}
      run: |
        set -euo pipefail
        images=(
          "${{ env.OPERATOR_NAME }}:${{ env.OPERATOR_VERSION }}"
          "redis/redis-stack-server:7.2.0-v10"
          "redis/redis-stack-server:7.4.0-v3"
          "alpine:3.21.3"
        )

        for img in "${images[@]}"; do
          # turn repo/tag into a DNS-safe Pod name (â‰¤63 chars)
          pod_name=$(echo "$img" | tr '/:.' '-' | cut -c1-63)

          echo "::group::Testing $img (pod: $pod_name)"
          kubectl run "$pod_name" \
            --image="$img" \
            --image-pull-policy=Never \
            --restart=Never \
            --command -- sh -c 'echo ok'

          # Give the kubelet up to 60s to unpack & start the container
          for i in {1..30}; do
            phase=$(kubectl get pod "$pod_name" -o jsonpath='{.status.phase}')
            case "$phase" in
              Running|Succeeded)
                echo "âœ…  $img is present and started (phase=$phase)"
                kubectl delete pod "$pod_name" --ignore-not-found
                echo "::endgroup::"
                break
                ;;
              Failed)
                echo "âŒ  $img failed to start (phase=Failed)"
                kubectl describe pod "$pod_name" || true
                exit 1
                ;;
            esac
            sleep 2
          done

          # Timeout guard
          if [[ "$phase" != "Running" && "$phase" != "Succeeded" ]]; then
            echo "âŒ  $img did not reach Running/Succeeded within 60 s (phase=$phase)"
            kubectl describe pod "$pod_name" || true
            exit 1
          fi
        done


    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“š  Install Ginkgo CLI
      run: go install github.com/onsi/ginkgo/v2/ginkgo@latest

    - name: âœ…  Run E2E test suite
      env:
        TEST_PARALLEL_PROCESSES: ${{ github.event.inputs.test_parallel_process || 4 }}
      run: |
        make test-e2e-cov \
          OPERATOR_IMAGE=${{ env.OPERATOR_NAME }}:${{ env.OPERATOR_VERSION }} \
          TEST_PARALLEL_PROCESS=${TEST_PARALLEL_PROCESSES} \
          GOMAXPROCS=${TEST_PARALLEL_PROCESSES}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ clean-up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: ğŸ§¹  Delete KinD cluster (always)
      if: always()
      run: kind delete cluster --name ${{ env.LOCAL_CLUSTER_NAME }}
