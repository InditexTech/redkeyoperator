name: E2E tests

on:
  pull_request:
    branches: [main]
    paths-ignore: ['docs/**']
  workflow_dispatch:
    inputs:
      test_parallel_process:
        description: 'Ginkgo parallel processes'
        default: '2'
        required: false

concurrency:
  group: e2e-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  OPERATOR_NAME:          redis-operator
  OPERATOR_VERSION:       0.1.0
  NODE_IMAGE:             kindest/node:v1.30.0
  KUBECONFIG:             ${{ github.workspace }}/.kube/config
  LOCAL_CLUSTER_NAME:     local-cluster-test
  LOCAL_REGISTRY:         local-registry-hosting
  LOCAL_REGISTRY_PORT:    5001
  DEP_IMAGES: |
    redis/redis-stack-server:7.2.0-v10
    redis/redis-stack-server:7.4.0-v3
    alpine:3.21.3

jobs:
  e2e:
    runs-on: ubuntu-24.04
    timeout-minutes: 120

    defaults:
      run:
        shell: bash -eu -o pipefail {0}

    steps:
    - name: ðŸ“¥  Checkout code
      uses: actions/checkout@v4

    - name: ðŸ—ï¸  Set up Go (with module cache)
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache: true

    - name: â™»ï¸  Restore BuildKit layer cache
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: buildx-${{ runner.os }}-${{ github.sha }}
        restore-keys: |
          buildx-${{ runner.os }}-

    - name: ðŸ³  Prepare Buildx builder
      uses: docker/setup-buildx-action@v3
      with:
        install: true
        driver-opts: image=moby/buildkit:v0.21.0
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to:   type=local,dest=/tmp/.buildx-cache,mode=max

    - name: â™»ï¸  Restore KinD node image
      id: node-cache
      uses: actions/cache@v4
      with:
        path: /tmp/kind-node.tar.gz
        key: kind-node-${{ env.NODE_IMAGE }}

    - name: ðŸ”„  Load node image from cache
      if: steps.node-cache.outputs.cache-hit == 'true'
      run: gunzip -c /tmp/kind-node.tar.gz | docker load --quiet

    - name: â™»ï¸  Restore dependency image cache
      id: deps-cache
      uses: actions/cache@v4
      with:
        path: /tmp/kind-deps.tar.gz
        key: kind-deps-${{ runner.os }}-v1

    - name: ðŸ”„  Load dependency images from cache
      if: steps.deps-cache.outputs.cache-hit == 'true'
      run: gunzip -c /tmp/kind-deps.tar.gz | docker load --quiet

    - name: ðŸ”§  Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: v1.30.0

    - name: ðŸŒ±  Create KinD cluster
      uses: helm/kind-action@v1
      with:
        cluster_name: ${{ env.LOCAL_CLUSTER_NAME }}
        image: ${{ env.NODE_IMAGE }}
        registry: true
        registry_name: ${{ env.LOCAL_REGISTRY }}
        registry_port: ${{ env.LOCAL_REGISTRY_PORT }}

    # If node image wasnâ€™t cached previously, export & save it now (one-time)
    - name: ðŸ’¾  Save node image to cache
      if: steps.node-cache.outputs.cache-hit != 'true'
      run: docker save ${{ env.NODE_IMAGE }} | gzip -1 > /tmp/kind-node.tar.gz

    - name: ðŸ—ï¸  Build operator image and load into KinD
      uses: docker/build-push-action@v5
      with:
        context: .
        tags: ${{ env.OPERATOR_NAME }}:${{ env.OPERATOR_VERSION }}
        load: true
        push: false
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to:   type=local,dest=/tmp/.buildx-cache,mode=max

    - name: ðŸ“¥ Load operator image into KinD
      run: kind load docker-image --name ${{ env.LOCAL_CLUSTER_NAME }} ${{ env.OPERATOR_NAME }}:${{ env.OPERATOR_VERSION }}

    - name: ðŸ“¦  Pull dependency images & load into KinD
      if: steps.deps-cache.outputs.cache-hit != 'true'
      run: |
        for img in ${{ env.DEP_IMAGES }}; do docker pull "$img"; done

    - name: ðŸ“¥  Load dependency images into KinD
      run: |
        for img in ${{ env.DEP_IMAGES }}; do kind load docker-image --name ${{ env.LOCAL_CLUSTER_NAME }} "$img"; done

    - name: ðŸ’¾  Save dependency images to cache
      if: steps.deps-cache.outputs.cache-hit != 'true'
      run: docker save ${{ env.DEP_IMAGES }} | gzip -1 > /tmp/kind-deps.tar.gz

    - name: ðŸ“š  Install Ginkgo CLI
      run: go install github.com/onsi/ginkgo/v2/ginkgo@latest

    - name: âœ…  Run E2E test suite
      env:
        TEST_PARALLEL_PROCESSES: ${{ github.event.inputs.test_parallel_process || 2 }}
      run: |
        make test-e2e-cov \
          OPERATOR_IMAGE=${{ env.OPERATOR_NAME }}:${{ env.OPERATOR_VERSION }} \
          TEST_PARALLEL_PROCESS=${TEST_PARALLEL_PROCESSES} \
          GOMAXPROCS=${TEST_PARALLEL_PROCESSES}

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ clean-up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    - name: ðŸ§¹  Delete KinD cluster (always)
      if: always()
      run: kind delete cluster --name ${{ env.LOCAL_CLUSTER_NAME }}
